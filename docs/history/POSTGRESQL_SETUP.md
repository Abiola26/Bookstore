# PostgreSQL Setup Guide for Bookstore API

## ‚úÖ Migration Complete: SQL Server ‚Üí PostgreSQL

Your Bookstore API is now configured to use **PostgreSQL** instead of SQL Server!

---

## üì¶ Prerequisites

### 1. Install PostgreSQL

**Windows:**
- Download from: https://www.postgresql.org/download/windows/
- Run the installer
- Remember the password for `postgres` user
- Default port: 5432

**macOS:**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib
sudo systemctl start postgresql
```

### 2. Verify PostgreSQL Installation

```bash
# Test connection
psql -U postgres
```

---

## üîß Configuration

### Update Connection String

Edit `Bookstore.API/appsettings.json`:

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=bookstoredb;Username=postgres;Password=your_password;SSL Mode=Require"
  }
}
```

**Connection String Parameters:**
- `Host`: PostgreSQL server hostname (default: localhost)
- `Port`: PostgreSQL port (default: 5432)
- `Database`: Database name (will be created)
- `Username`: PostgreSQL user (default: postgres)
- `Password`: Your PostgreSQL password
- `SSL Mode`: Require (secure), Disable (dev only)

### For Development (No SSL)

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=bookstoredb;Username=postgres;Password=your_password;SSL Mode=Disable"
  }
}
```

### For Docker PostgreSQL

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=host.docker.internal;Port=5432;Database=bookstoredb;Username=postgres;Password=your_password;SSL Mode=Disable"
  }
}
```

---

## üóÑÔ∏è Create Database

### Option 1: Using psql Command Line

```bash
# Connect as postgres user
psql -U postgres

# Create database
CREATE DATABASE bookstoredb;

# List databases
\l

# Disconnect
\q
```

### Option 2: Using pgAdmin (GUI)

1. Install pgAdmin: https://www.pgadmin.org/download/
2. Connect to PostgreSQL server
3. Right-click on "Databases" ‚Üí Create ‚Üí Database
4. Name: `bookstoredb`
5. Click "Save"

### Option 3: Let Entity Framework Create It

Entity Framework will create the database when you run migrations:
```bash
dotnet ef database update
```

---

## üìä Create Tables with Migrations

### Step 1: Delete Old Migrations (if migrating from SQL Server)

```bash
cd Bookstore.Infrastructure

# Remove all migrations
Remove-Migration -Force
# Repeat until all migrations are removed
```

### Step 2: Create Initial Migration for PostgreSQL

```bash
cd Bookstore.Infrastructure

# Create new migration
dotnet ef migrations add InitialCreate

# Apply migration
dotnet ef database update
```

### Step 3: Verify Tables Created

```bash
# Connect to database
psql -U postgres -d bookstoredb

# List tables
\dt

# Describe table
\d "Books"

# Disconnect
\q
```

---

## üöÄ Run Application

```bash
cd Bookstore.API
dotnet run

# Application starts at: https://localhost:5001
# Swagger UI: https://localhost:5001/swagger
```

---

## üß™ Test PostgreSQL Connection

### Using Entity Framework

```csharp
// In Program.cs, add this to test connection:
using (var scope = app.Services.CreateScope())
{
    var dbContext = scope.ServiceProvider
        .GetRequiredService<BookStoreDbContext>();
    
    if (await dbContext.Database.CanConnectAsync())
    {
        Console.WriteLine("‚úÖ Successfully connected to PostgreSQL!");
    }
    else
    {
        Console.WriteLine("‚ùå Failed to connect to PostgreSQL!");
    }
}
```

### Using Postman

1. Register a user: `POST /api/auth/register`
2. Create a category: `POST /api/categories`
3. Create a book: `POST /api/books`
4. Check Swagger: `GET /swagger/index.html`

---

## üìù Important PostgreSQL Differences

### Case Sensitivity
PostgreSQL identifiers are **case-insensitive by default but stored lowercase**.
- Table names: automatically lowercase
- Column names: automatically lowercase
- Use quotes for exact case: `"UserId"`

EF Core handles this automatically, so no changes needed!

### Boolean Columns
PostgreSQL uses `BOOLEAN` type (T/F).
EF Core maps `bool` correctly.

### GUID/UUID
PostgreSQL uses `uuid` for GUIDs.
```sql
-- Automatically generated by EF Core
id uuid PRIMARY KEY DEFAULT gen_random_uuid()
```

### String Length
PostgreSQL VARCHAR doesn't have max length but EF Core enforces it in validation.

### Timestamps
PostgreSQL supports `TIMESTAMP WITH TIME ZONE` for audit fields.
```csharp
public DateTimeOffset CreatedAt { get; set; }  // Automatically handled
```

### Indexes
PostgreSQL syntax is similar to SQL Server. EF Core handles index creation.

---

## üîß PostgreSQL Configuration Tips

### Connection Pooling

PostgreSQL connection pooling is built into Npgsql:
```csharp
// Already configured in DependencyInjection.cs
options.EnableRetryOnFailure(3, TimeSpan.FromSeconds(10), null);
```

### Performance Optimization

```bash
# Connect to database
psql -U postgres -d bookstoredb

# Analyze database
ANALYZE;

# Check index usage
SELECT * FROM pg_stat_user_indexes;

# Vacuum (cleanup)
VACUUM ANALYZE;
```

---

## üê≥ Using Docker Compose for PostgreSQL

Create `docker-compose.yml`:

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: bookstore-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_password
      POSTGRES_DB: bookstoredb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

Run:
```bash
docker-compose up -d
```

---

## üìã Common Issues & Solutions

### Issue: "Connection refused"
**Solution:**
- Verify PostgreSQL is running: `systemctl status postgresql` (Linux) or check Services (Windows)
- Verify port 5432 is correct
- Verify hostname/IP is correct

### Issue: "role 'postgres' does not exist"
**Solution:**
- Reinstall PostgreSQL
- Check username in connection string

### Issue: "database 'bookstoredb' does not exist"
**Solution:**
- Create database first: `CREATE DATABASE bookstoredb;`
- Or run migrations: `dotnet ef database update`

### Issue: "SSL certificate problem"
**Solution:**
- For development, use: `SSL Mode=Disable`
- For production, use: `SSL Mode=Require` with proper certificates

### Issue: "Timeout connecting"
**Solution:**
- Increase timeout: `Command Timeout=60`
- Check firewall allows port 5432

---

## üîê Production Setup

### Environment Variables

```bash
# Linux/macOS
export ASPNETCORE_ENVIRONMENT=Production
export PGHOST=your.postgresql.server
export PGPORT=5432
export PGDATABASE=bookstoredb
export PGUSER=appuser
export PGPASSWORD=secure_password

# Or in .env file
ASPNETCORE_ENVIRONMENT=Production
ConnectionString=Host=your.postgresql.server;Port=5432;Database=bookstoredb;Username=appuser;Password=secure_password;SSL Mode=Require
```

### Database User (Principle of Least Privilege)

```sql
-- As superuser (postgres)
CREATE USER appuser WITH PASSWORD 'secure_password';
CREATE DATABASE bookstoredb OWNER appuser;
GRANT CONNECT ON DATABASE bookstoredb TO appuser;
GRANT USAGE ON SCHEMA public TO appuser;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO appuser;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO appuser;
```

---

## üìä PostgreSQL Tools

### pgAdmin (GUI)
- Download: https://www.pgadmin.org/download/
- Connect to PostgreSQL visually
- Run queries, manage databases

### DBeaver (Universal Database Tool)
- Download: https://dbeaver.io/
- Supports PostgreSQL and many others
- Free Community Edition

### psql (Command Line)
```bash
# Connect
psql -h localhost -U postgres -d bookstoredb

# Useful commands
\dt           # List tables
\d table_name # Describe table
\l            # List databases
\du           # List users
\x            # Toggle expanded display
SELECT version(); # Check PostgreSQL version
```

---

## üìö Next Steps

1. ‚úÖ Update `appsettings.json` with your PostgreSQL credentials
2. ‚úÖ Install PostgreSQL (if not already installed)
3. ‚úÖ Create `bookstoredb` database
4. ‚úÖ Run migrations: `dotnet ef database update`
5. ‚úÖ Start application: `dotnet run`
6. ‚úÖ Test API: Visit `/swagger`

---

## üîó Useful Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Npgsql Documentation](https://www.npgsql.org/)
- [EF Core PostgreSQL Provider](https://www.npgsql.org/efcore/)
- [PostgreSQL Tutorial](https://www.postgresqltutorial.com/)

---

## ‚úÖ Verification Checklist

- [ ] PostgreSQL installed and running
- [ ] Connection string updated in appsettings.json
- [ ] Database `bookstoredb` created
- [ ] Migrations applied successfully
- [ ] Application starts without errors
- [ ] Swagger API documentation accessible
- [ ] Can create user (POST /api/auth/register)
- [ ] Can create category (POST /api/categories)
- [ ] Can create book (POST /api/books)

---

**PostgreSQL Setup Complete! üéâ**

Your Bookstore API is now ready to use PostgreSQL!

---

**Last Updated**: January 2025
**PostgreSQL Version**: 15.0+ (or 10+)
**Npgsql Version**: 10.0.0
**EF Core Version**: 10.0.3
